#!/usr/bin/env python2.4

import os, sys
import plasTeX
import codecs
from plasTeX.TeX import TeX
from plasTeX.TALUtils import *
from plasTeX.Tokenizer import Node

encoding = 'utf-8'

print >>sys.stderr, 'plasTeX version 1.0'
file = sys.argv[1]
basename = os.path.splitext(file)[0]

# Parse document
s = TeX(codecs.open(file,'r',encoding))
document = s.parse()

# Write expanded source file
sourcefile = '%s.source' % basename
codecs.open(sourcefile,'w',encoding).write(document.source)

# Locate the document element
document = [x for x in document if x.level == Node.DOCUMENT_LEVEL].pop()

# Write XML dump
outfile = '%s.xml' % basename
codecs.open(outfile,'w',encoding).write(document.toXML())

# Apply renderer
from plasTeX.renderers.xhtml import xhtml as renderer
s.context.applyRenderer(renderer)

# Render output
outfile = '%s.html' % basename
codecs.open(outfile,'w',encoding).write(str(document))
