#!/usr/bin/env python2.3

import os, sys
import plasTeX
import codecs
from plasTeX.TeX import TeX
from plasTeX.TALUtils import *
from plasTeX.Tokenizer import Node

encoding = 'utf-8'

print >>sys.stderr, 'plasTeX version 1.0'
file = sys.argv[1]
basename = os.path.splitext(file)[0]

# Parse document
s = TeX(codecs.open(file,'r',encoding))
document = s.parse()
#print document.source
sourcefile = '%s.source' % basename
codecs.open(sourcefile,'w',encoding).write(document.source)
document = [x for x in document if x.nodeType == Node.ELEMENT_NODE and x.nodeName == 'document'].pop()
outfile = '%s.xml' % basename
codecs.open(outfile,'w',encoding).write(document.toXML())
sys.exit()

# Apply renderer
from plasTeX.renderers.xhtml import xhtml as renderer
s.context.applyRenderer(renderer)

# Render output
renderer.imager.addtopreamble(document.preamble)
print document.render(file=basename+'.html')
renderer.imager.close()
